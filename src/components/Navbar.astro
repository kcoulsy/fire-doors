---
// Component script
import { Image } from "astro:assets";
import LinkedInIcon from "../icons/LinkedInIcon.astro";
import YouTubeIcon from "../icons/YouTubeIcon.astro";
import Dropdown from "./Dropdown.astro";
import AISmartSearch from "./AISmartSearch.astro";
import { DETAILS } from "../constants/details";

import coulsyLogo from "../assets/images/coulsy-logo-sm.jpg";

interface Props {
  transparent?: boolean;
}

const { transparent = false } = Astro.props;

const menuitems = [
  {
    label: "Services",
    link: "/fire-door-services",
    items: [
      { label: "Fire Door Installation", link: "/fire-door-installers" },
      { label: "Fire Door Maintenance", link: "/fire-door-maintenance" },
      { label: "Fire Door Inspections", link: "/fire-door-inspectors" },
      { label: "All Services", link: "/fire-door-services" },
    ],
  },
  {
    label: "About",
    link: "/about",
    items: [
      { label: "About Us", link: "/about" },
      { label: "Qualifications", link: "/qualifications" },
      { label: "Compliance", link: "/compliance" },
      { label: "Sustainability", link: "/sustainability" },
      { label: "FAQ", link: "/faq" },
    ],
  },
  {
    label: "Contact",
    link: "/contact",
  },
];

const socialLinks = [
  {
    label: "LinkedIn",
    href: DETAILS.SOCIALS.LINKEDIN,
    icon: LinkedInIcon,
  },
  {
    label: "YouTube",
    href: DETAILS.SOCIALS.YOUTUBE,
    icon: YouTubeIcon,
  },
];
---

<header
  class={`${transparent ? "bg-transparent" : "bg-[#1e2a38]"} text-white fixed top-0 left-0 right-0 z-50 transition-all duration-300 shadow-lg body-font`}
  id="navbar"
>
  <div
    class="container mx-auto flex items-center justify-between px-4 py-2 lg:py-3 h-[70px] lg:h-[80px]"
  >
    <!-- Logo -->
    <div class="relative z-10 flex-shrink-0">
      <a href="/" class="block">
        <Image
          src={coulsyLogo}
          width="100"
          height="100"
          class="h-[60px] sm:h-[70px] lg:h-[80px] w-auto object-contain block"
          alt="Coulsy Fire Door Services"
          loading="eager"
        />
      </a>
    </div>

    <!-- Desktop Navigation -->
    <nav
      class="hidden lg:flex items-center space-x-6 ml-4 flex-1 justify-center"
      aria-label="Main navigation"
    >
      <ul class="flex items-center gap-4">
        {
          menuitems.map((item) =>
            item.items ? (
              <li>
                <div class="text-[#c0c0c0] hover:text-white transition-colors duration-200">
                  <Dropdown label={item.label} items={item.items} />
                </div>
              </li>
            ) : (
              <li>
                <a
                  href={item.link}
                  class="text-[#c0c0c0] hover:text-white transition-colors duration-200 px-2 py-2"
                >
                  {item.label}
                </a>
              </li>
            )
          )
        }
      </ul>
    </nav>

    <!-- Desktop Right Section -->
    <div class="hidden lg:flex items-center gap-4 flex-shrink-0">
      <!-- AI Smart Search -->
      <div class="w-64">
        <AISmartSearch />
      </div>

      <!-- Contact Info - Phone Only (Email removed for space) -->
      <div class="flex items-center gap-2 ml-4">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="currentColor"
          class="w-5 h-5 text-white"
        >
          <path
            fill-rule="evenodd"
            d="M1.5 4.5a3 3 0 013-3h1.372c.86 0 1.61.586 1.819 1.42l1.105 4.423a1.875 1.875 0 01-.694 1.955l-1.293.97c-.135.101-.164.249-.126.352a11.285 11.285 0 006.697 6.697c.103.038.25.009.352-.126l.97-1.293a1.875 1.875 0 011.955-.694l4.423 1.105c.834.209 1.42.959 1.42 1.82V19.5a3 3 0 01-3 3h-2.25C8.552 22.5 1.5 15.448 1.5 6.75V4.5z"
            clip-rule="evenodd"></path>
        </svg>
        <a
          href={`tel:${DETAILS.COMPANY.PHONE}`}
          class="text-[#c0c0c0] hover:text-white transition-colors duration-200 whitespace-nowrap"
        >
          {DETAILS.COMPANY.PHONE}
        </a>
      </div>

      <!-- Social Icons -->
      <div class="flex items-center gap-3 ml-4">
        {
          socialLinks.map((social) => (
            <a
              href={social.href}
              target="_blank"
              rel="noopener noreferrer"
              aria-label={social.label}
              class="group text-[#c0c0c0] hover:text-white transition-colors duration-200"
            >
              <social.icon
                className="h-7 w-7 transition-colors duration-200 group-hover:fill-white fill-[#c0c0c0]"
                aria-hidden="true"
              />
            </a>
          ))
        }
      </div>
    </div>

    <!-- Mobile Nav Toggle -->
    <button
      id="mobile-nav-toggle"
      class="block lg:hidden ml-auto p-2 touch-manipulation"
      aria-label="Open menu"
      aria-expanded="false"
      aria-controls="mobile-nav-menu"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 448 512"
        class="w-6 h-6 text-white fill-white"
        aria-hidden="true"
      >
        <path
          d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"
        ></path>
      </svg>
    </button>
  </div>

  <!-- Mobile Menu Overlay -->
  <div
    id="mobile-nav-overlay"
    class="fixed inset-0 bg-black/50 z-[55] opacity-0 transition-opacity duration-300 ease-in-out pointer-events-none"
    aria-hidden="true"
  >
  </div>

  <!-- Mobile Menu -->
  <nav
    id="mobile-nav-menu"
    class="fixed top-0 left-0 w-full max-h-screen bg-[#1e2a38] transform -translate-y-full transition-transform duration-300 ease-in-out z-[60] overflow-y-auto body-font"
    aria-label="Mobile navigation"
    aria-hidden="true"
  >
    <!-- Mobile Menu Header -->
    <div
      class="flex items-center justify-between px-6 py-4 border-b border-[#1e3a8a] sticky top-0 bg-[#1e2a38] z-10"
    >
      <a href="/" class="flex items-center text-[#c0c0c0]">
        <Image
          src={coulsyLogo}
          width="60"
          height="60"
          class="h-[60px] w-auto object-contain"
          alt="Coulsy Fire Door Services"
          loading="eager"
        />
      </a>
      <button
        id="mobile-nav-close"
        class="p-2 touch-manipulation"
        aria-label="Close menu"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="3"
          class="w-6 h-6 text-white"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <!-- Mobile Contact Info -->
    <div class="px-6 py-4 border-b border-[#1e3a8a] bg-[#1e3a8a]/20">
      <div class="flex flex-col gap-3">
        <!-- Phone -->
        <a
          href={`tel:${DETAILS.COMPANY.PHONE}`}
          class="flex items-center gap-3 text-white hover:text-[#e0e0e0] transition-colors duration-200 touch-manipulation"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="currentColor"
            class="w-5 h-5"
          >
            <path
              fill-rule="evenodd"
              d="M1.5 4.5a3 3 0 013-3h1.372c.86 0 1.61.586 1.819 1.42l1.105 4.423a1.875 1.875 0 01-.694 1.955l-1.293.97c-.135.101-.164.249-.126.352a11.285 11.285 0 006.697 6.697c.103.038.25.009.352-.126l.97-1.293a1.875 1.875 0 011.955-.694l4.423 1.105c.834.209 1.42.959 1.42 1.82V19.5a3 3 0 01-3 3h-2.25C8.552 22.5 1.5 15.448 1.5 6.75V4.5z"
              clip-rule="evenodd"></path>
          </svg>
          <span class="text-lg">{DETAILS.COMPANY.PHONE}</span>
        </a>

        <!-- Email -->
        <a
          href={`mailto:${DETAILS.COMPANY.EMAIL}`}
          class="flex items-center gap-3 text-white hover:text-[#e0e0e0] transition-colors duration-200 touch-manipulation"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="currentColor"
            class="w-5 h-5"
          >
            <path
              d="M1.5 8.67v8.58a3 3 0 003 3h15a3 3 0 003-3V8.67l-8.928 5.493a3 3 0 01-3.144 0L1.5 8.67z"
            ></path>
            <path
              d="M22.5 6.908V6.75a3 3 0 00-3-3h-15a3 3 0 00-3 3v.158l9.714 5.978a1.5 1.5 0 001.572 0L22.5 6.908z"
            ></path>
          </svg>
          <span class="text-lg break-all">{DETAILS.COMPANY.EMAIL}</span>
        </a>
      </div>
    </div>

    <!-- Mobile Navigation -->
    <ul class="flex flex-col w-full">
      {
        menuitems.map((item) => (
          <li class="flex flex-col items-center group">
            {item.items ? (
              <>
                <button
                  class="flex w-full px-6 py-5 text-white hover:text-[#e0e0e0] text-xl justify-between items-center border-b border-[#1e3a8a] touch-manipulation"
                  aria-expanded="false"
                  aria-controls={`mobile-dropdown-${item.label.toLowerCase().replace(/\s+/g, "-")}`}
                >
                  {item.label}
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="3"
                    stroke="currentColor"
                    class="w-4 h-4 transition-transform duration-200 group-[.is-open]:rotate-180"
                    aria-hidden="true"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M19.5 8.25l-7.5 7.5-7.5-7.5"
                    />
                  </svg>
                </button>
                <ul
                  id={`mobile-dropdown-${item.label.toLowerCase().replace(/\s+/g, "-")}`}
                  class="hidden group-[.is-open]:block w-full bg-[#1e3a8a] transform origin-top transition-all duration-300 ease-in-out max-h-0 group-[.is-open]:max-h-[60vh] group-[.is-open]:overflow-y-auto overflow-hidden"
                  role="menu"
                  aria-orientation="vertical"
                >
                  {item.items.map((subitem) => (
                    <li role="none">
                      <a
                        href={subitem.link}
                        class="block px-6 py-4 text-white hover:text-[#e0e0e0] text-lg border-b border-[#1e2a38] transition-colors duration-200 touch-manipulation"
                        role="menuitem"
                      >
                        {subitem.label}
                      </a>
                    </li>
                  ))}
                </ul>
              </>
            ) : (
              <a
                href={item.link}
                class="block w-full px-6 py-5 text-white text-left hover:text-[#e0e0e0] text-xl border-b border-[#1e3a8a] transition-colors duration-200 touch-manipulation"
              >
                {item.label}
              </a>
            )}
          </li>
        ))
      }

      <!-- Social Icons in Mobile Menu -->
      <li
        class="flex items-center justify-center gap-6 px-6 py-6 border-b border-[#1e3a8a]"
        aria-label="Social media links"
      >
        {
          socialLinks.map((social) => (
            <a
              href={social.href}
              target="_blank"
              rel="noopener noreferrer"
              aria-label={social.label}
              class="text-white hover:text-[#e0e0e0] transition-colors duration-200 touch-manipulation"
            >
              <social.icon
                className="h-8 w-8 fill-[#c0c0c0]"
                aria-hidden="true"
              />
            </a>
          ))
        }
      </li>
    </ul>
  </nav>
</header>

<!-- Spacer to prevent content from being hidden behind fixed navbar -->
<div class="h-[70px] lg:h-[80px]"></div>

<script>
  const toggle = document.getElementById("mobile-nav-toggle");
  const closeButton = document.getElementById("mobile-nav-close");
  const menu = document.getElementById("mobile-nav-menu");
  const overlay = document.getElementById("mobile-nav-overlay");
  const dropdowns = menu?.querySelectorAll("button");
  const navbar = document.getElementById("navbar");

  // Handle scroll effects for navbar
  let ticking = false;

  const updateNavbar = () => {
    const currentScrollY = window.scrollY;

    if (navbar) {
      // Add shadow and background when scrolled
      if (currentScrollY > 10) {
        navbar.classList.add(
          "shadow-xl",
          "bg-[#1e2a38]/95",
          "backdrop-blur-sm"
        );
        navbar.classList.remove("bg-[#1e2a38]");
      } else {
        navbar.classList.remove(
          "shadow-xl",
          "bg-[#1e2a38]/95",
          "backdrop-blur-sm"
        );
        navbar.classList.add("bg-[#1e2a38]");
      }
    }

    ticking = false;
  };

  const requestTick = () => {
    if (!ticking) {
      requestAnimationFrame(updateNavbar);
      ticking = true;
    }
  };

  // Only add scroll listener if navbar exists
  if (navbar) {
    window.addEventListener("scroll", requestTick, { passive: true });
  }

  // Handle keyboard navigation for desktop dropdowns
  document
    .querySelectorAll("nav.lg\\:flex li.group button")
    .forEach((button) => {
      button.addEventListener("keydown", ((e: KeyboardEvent) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          const dropdown = button.closest("li.group");
          if (dropdown) {
            const ul = dropdown.querySelector("ul");
            const isExpanded = button.getAttribute("aria-expanded") === "true";

            // Close all other dropdowns
            document
              .querySelectorAll("nav.lg\\:flex li.group")
              .forEach((otherDropdown) => {
                if (otherDropdown !== dropdown) {
                  const otherButton = otherDropdown.querySelector("button");
                  const otherUl = otherDropdown.querySelector("ul");
                  if (otherButton && otherUl) {
                    otherButton.setAttribute("aria-expanded", "false");
                    otherUl.classList.remove("scale-y-100");
                  }
                }
              });

            button.setAttribute("aria-expanded", String(!isExpanded));
            if (ul) {
              ul.classList.toggle("scale-y-100");
            }
          }
        }
      }) as EventListener);
    });

  // Handle keyboard navigation for mobile menu
  const toggleMenu = () => {
    const isOpen = menu?.classList.contains("-translate-y-full");
    menu?.classList.toggle("-translate-y-full");
    overlay?.classList.toggle("opacity-0");
    overlay?.classList.toggle("pointer-events-none");
    document.body.classList.toggle("overflow-hidden");

    // Update ARIA attributes
    if (toggle && menu && overlay) {
      toggle.setAttribute("aria-expanded", String(!isOpen));
      menu.setAttribute("aria-hidden", String(isOpen));
      overlay.setAttribute("aria-hidden", String(isOpen));
    }

    // Focus management
    if (!isOpen) {
      // When opening menu, focus first interactive element
      const firstFocusable = menu?.querySelector("button, a");
      if (firstFocusable instanceof HTMLElement) {
        firstFocusable.focus();
      }
    } else {
      // When closing menu, return focus to toggle button
      toggle?.focus();
    }
  };

  // Handle keyboard navigation for mobile dropdowns
  dropdowns?.forEach((dropdown) => {
    if (dropdown.id !== "mobile-nav-close") {
      // Add click event handler
      dropdown.addEventListener("click", (e) => {
        e.preventDefault();
        const group = dropdown.closest("li");
        const isExpanded = dropdown.getAttribute("aria-expanded") === "true";

        // Close all other dropdowns
        menu?.querySelectorAll("li.is-open").forEach((openGroup) => {
          if (openGroup !== group) {
            const button = openGroup.querySelector("button");
            if (button) {
              button.setAttribute("aria-expanded", "false");
            }
            openGroup.classList.remove("is-open");
          }
        });

        dropdown.setAttribute("aria-expanded", String(!isExpanded));
        group?.classList.toggle("is-open");
      });

      dropdown.addEventListener("keydown", (e: KeyboardEvent) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          const group = dropdown.closest("li");
          const isExpanded = dropdown.getAttribute("aria-expanded") === "true";

          // Close all other dropdowns
          menu?.querySelectorAll("li.is-open").forEach((openGroup) => {
            if (openGroup !== group) {
              const button = openGroup.querySelector("button");
              if (button) {
                button.setAttribute("aria-expanded", "false");
              }
              openGroup.classList.remove("is-open");
            }
          });

          dropdown.setAttribute("aria-expanded", String(!isExpanded));
          group?.classList.toggle("is-open");
        }
      });
    }
  });

  toggle?.addEventListener("click", toggleMenu);
  closeButton?.addEventListener("click", toggleMenu);
  overlay?.addEventListener("click", toggleMenu);

  // Handle desktop dropdown hover states
  document.querySelectorAll("nav.lg\\:flex li.group").forEach((dropdown) => {
    dropdown.addEventListener("mouseenter", () => {
      // Close all other dropdowns
      document
        .querySelectorAll("nav.lg\\:flex li.group")
        .forEach((otherDropdown) => {
          if (otherDropdown !== dropdown) {
            const button = otherDropdown.querySelector("button");
            const ul = otherDropdown.querySelector("ul");
            if (button && ul) {
              button.setAttribute("aria-expanded", "false");
              ul.classList.remove("scale-y-100");
            }
          }
        });

      // Open current dropdown
      const button = dropdown.querySelector("button");
      const ul = dropdown.querySelector("ul");
      if (button && ul) {
        button.setAttribute("aria-expanded", "true");
        ul.classList.add("scale-y-100");
      }
    });

    dropdown.addEventListener("mouseleave", () => {
      const button = dropdown.querySelector("button");
      const ul = dropdown.querySelector("ul");
      if (button && ul) {
        button.setAttribute("aria-expanded", "false");
        ul.classList.remove("scale-y-100");
      }
    });
  });
</script>

<style>
  /* Ensure smooth transitions for navbar */
  #navbar {
    transition: all 0.3s ease-in-out;
  }

  /* Add backdrop blur effect when scrolled */
  #navbar.shadow-xl {
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }

  /* Ensure dropdowns appear above other content */
  nav.lg\\:flex li.group ul {
    z-index: 60;
  }

  /* Mobile menu adjustments for fixed navbar */
  #mobile-nav-menu {
    top: 0;
    height: 100vh;
    padding-top: 0;
  }

  /* Ensure content doesn't overlap with fixed navbar */
  body {
    padding-top: 0;
  }

  /* Touch-friendly mobile interactions */
  @media (max-width: 1023px) {
    button,
    a {
      min-height: 44px;
      min-width: 44px;
    }
  }

  /* Tablet-specific optimizations */
  @media (min-width: 768px) and (max-width: 1023px) {
    #mobile-nav-menu {
      max-width: 400px;
      right: 0;
      left: auto;
    }
  }
</style>
